<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear English Pro</title>
    <!-- FAVICON PREMIUM V2 -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><defs><linearGradient id=%22grad%22 x1=%220%25%22 y1=%220%25%22 x2=%22100%25%22 y2=%22100%25%22><stop offset=%220%25%22 stop-color=%22%233b82f6%22/><stop offset=%22100%25%22 stop-color=%22%238b5cf6%22/></linearGradient></defs><rect width=%2224%22 height=%2224%22 rx=%228%22 fill=%22url(%23grad)%22/><path d=%22M13 3L4 14h9l-1 8 9-12h-9l1-7z%22 fill=%22white%22 stroke=%22white%22 stroke-width=%222.5%22 stroke-linejoin=%22round%22 stroke-linecap=%22round%22/></svg>">
   
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Carga estable de Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
   
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
       
        body { font-family: 'Plus Jakarta Sans', sans-serif; }

        @keyframes lightningPulse {
            0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0px rgba(79, 70, 229, 0)); }
            30% { transform: scale(1.2) rotate(-10deg); filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.6)); }
            60% { transform: scale(1.1) rotate(10deg); filter: drop-shadow(0 0 10px rgba(79, 70, 229, 0.4)); }
            100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0px rgba(79, 70, 229, 0)); }
        }
        .animate-lightning { animation: lightningPulse 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes smoothEntrance {
            0% { opacity: 0; transform: translateY(10px); filter: blur(4px); }
            100% { opacity: 1; transform: translateY(0); filter: blur(0); }
        }
        .animate-smooth-view { animation: smoothEntrance 0.4s ease-out forwards; }

        @keyframes staggerSlideIn {
            0% { opacity: 0; transform: translateX(-15px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .animate-stagger-item { animation: staggerSlideIn 0.3s ease-out forwards; }

        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 60% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
       
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }

        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05); }
        .gradient-text { background: linear-gradient(to r, #2563eb, #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 min-h-screen text-slate-900 overflow-x-hidden selection:bg-indigo-200">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
       
        const { useState, useEffect, useRef } = React;

        // -----------------------------------------------------------
        // ⚠️ IMPORTANTE PARA GITHUB: PEGA TU CONFIG DE FIREBASE AQUÍ ⚠️
        // Si lo dejas vacío, la app funcionará en "Modo Demo" (sin Google real).
        // -----------------------------------------------------------
        const firebaseConfigOverride = {
            // apiKey: "TU_API_KEY",
            // authDomain: "TU_DOMINIO.firebaseapp.com",
            // projectId: "TU_PROJECT_ID",
            // ... etc
        };

        // --- SAFE FIREBASE INITIALIZATION ---
        let auth, provider;
        let isFirebaseActive = false;

        try {
            // Priority: User config > Environment config > Empty
            const configToUse = Object.keys(firebaseConfigOverride).length > 0
                ? firebaseConfigOverride
                : (typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {});

            if (Object.keys(configToUse).length > 0 && configToUse.apiKey) {
                const app = initializeApp(configToUse);
                auth = getAuth(app);
                provider = new GoogleAuthProvider();
                isFirebaseActive = true;
            } else {
                console.warn("No Firebase config found. Running in Demo Mode.");
            }
        } catch (e) {
            console.error("Firebase init failed:", e);
        }

        // --- ICON COMPONENT (ROBUST) ---
        const Icon = ({ name, size = 24, className = "", fill = "none" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className} style={{ fill: fill === 'none' ? 'transparent' : fill }}></i>;
        };

        // --- DATA CONSTANTS (VERBS & GRAMMAR) ---
        const VERBS_IRREGULAR = [
            { base: "be", past: "was/were", pp: "been" }, { base: "beat", past: "beat", pp: "beaten" }, { base: "become", past: "became", pp: "become" }, { base: "begin", past: "began", pp: "begun" }, { base: "bite", past: "bit", pp: "bitten" }, { base: "break", past: "broke", pp: "broken" }, { base: "bring", past: "brought", pp: "brought" }, { base: "build", past: "built", pp: "built" }, { base: "buy", past: "bought", pp: "bought" }, { base: "catch", past: "caught", pp: "caught" }, { base: "choose", past: "chose", pp: "chosen" }, { base: "come", past: "came", pp: "come" }, { base: "cost", past: "cost", pp: "cost" }, { base: "cut", past: "cut", pp: "cut" }, { base: "do", past: "did", pp: "done" }, { base: "draw", past: "drew", pp: "drawn" }, { base: "drink", past: "drank", pp: "drunk" }, { base: "drive", past: "drove", pp: "driven" }, { base: "eat", past: "ate", pp: "eaten" }, { base: "fall", past: "fell", pp: "fallen" }, { base: "feel", past: "felt", pp: "felt" }, { base: "fight", past: "fought", pp: "fought" }, { base: "find", past: "found", pp: "found" }, { base: "fly", past: "flew", pp: "flown" }, { base: "forget", past: "forgot", pp: "forgotten" }, { base: "forgive", past: "forgave", pp: "forgiven" }, { base: "freeze", past: "froze", pp: "frozen" }, { base: "get", past: "got", pp: "got" }, { base: "give", past: "gave", pp: "given" }, { base: "go", past: "went", pp: "gone" }, { base: "grow", past: "grew", pp: "grown" }, { base: "have", past: "had", pp: "had" }, { base: "hear", past: "heard", pp: "heard" }, { base: "hide", past: "hid", pp: "hidden" }, { base: "hit", past: "hit", pp: "hit" }, { base: "hold", past: "held", pp: "held" }, { base: "hurt", past: "hurt", pp: "hurt" }, { base: "keep", past: "kept", pp: "kept" }, { base: "know", past: "knew", pp: "known" }, { base: "leave", past: "left", pp: "left" }, { base: "lend", past: "lent", pp: "lent" }, { base: "let", past: "let", pp: "let" }, { base: "lose", past: "lost", pp: "lost" }, { base: "make", past: "made", pp: "made" }, { base: "meet", past: "met", pp: "met" }, { base: "pay", past: "paid", pp: "paid" }, { base: "put", past: "put", pp: "put" }, { base: "read", past: "read", pp: "read" }, { base: "ride", past: "rode", pp: "ridden" }, { base: "ring", past: "rang", pp: "rung" }, { base: "run", past: "ran", pp: "run" }, { base: "say", past: "said", pp: "said" }, { base: "see", past: "saw", pp: "seen" }, { base: "sell", past: "sold", pp: "sold" }, { base: "send", past: "sent", pp: "sent" }, { base: "sing", past: "sang", pp: "sung" }, { base: "sit", past: "sat", pp: "sat" }, { base: "sleep", past: "slept", pp: "slept" }, { base: "slide", past: "slid", pp: "slid" }, { base: "speak", past: "spoke", pp: "spoken" }, { base: "spend", past: "spent", pp: "spent" }, { base: "spill", past: "spilt/spilled", pp: "spilt/spilled" }, { base: "spin", past: "spun", pp: "spun" }, { base: "split", past: "split", pp: "split" }, { base: "spread", past: "spread", pp: "spread" }, { base: "stand", past: "stood", pp: "stood" }, { base: "steal", past: "stole", pp: "stolen" }, { base: "stick", past: "stuck", pp: "stuck" }, { base: "sting", past: "stung", pp: "stung" }, { base: "strike", past: "struck", pp: "struck" }, { base: "swear", past: "swore", pp: "sworn" }, { base: "sweep", past: "swept", pp: "swept" }, { base: "swim", past: "swam", pp: "swum" }, { base: "take", past: "took", pp: "taken" }, { base: "teach", past: "taught", pp: "taught" }, { base: "tear", past: "tore", pp: "torn" }, { base: "tell", past: "told", pp: "told" }, { base: "think", past: "thought", pp: "thought" }, { base: "throw", past: "threw", pp: "thrown" }, { base: "understand", past: "understood", pp: "understood" }, { base: "wake", past: "woke", pp: "woken" }, { base: "wear", past: "wore", pp: "worn" }, { base: "weep", past: "wept", pp: "wept" }, { base: "win", past: "won", pp: "won" }, { base: "wind", past: "wound", pp: "wound" }, { base: "write", past: "wrote", pp: "written" }
        ];

        const SUBJECTS = ["I", "You", "He", "She", "It", "We", "They", "The student", "My friend", "The teacher", "The doctor", "Everyone", "Nobody"];
        const OBJECTS = ["the car", "the book", "a letter", "the house", "dinner", "the game", "a song", "the window", "an apple", "the piano", "English", "football", "a movie", "the answer", "coffee"];
        const TIME_PAST = ["yesterday", "last week", "in 2010", "two days ago", "last night"];
        const TIME_FUTURE = ["tomorrow", "next week", "soon", "later", "tonight"];
        const TIME_FREQ = ["usually", "always", "often", "every day", "sometimes"];
        const BE_FORMS = { "I": "am", "You": "are", "He": "is", "She": "is", "It": "is", "We": "are", "They": "are", "The student": "is", "My friend": "is", "The teacher": "is", "The doctor": "is", "Everyone": "is", "Nobody": "is" };
        const VERBS_REGULAR = [
            { base: "play", ing: "playing", past: "played" }, { base: "work", ing: "working", past: "worked" }, { base: "live", ing: "living", past: "lived" },
            { base: "walk", ing: "walking", past: "walked" }, { base: "watch", ing: "watching", past: "watched" }, { base: "listen", ing: "listening", past: "listened" },
            { base: "cook", ing: "cooking", past: "cooked" }, { base: "study", ing: "studying", past: "studied" }, { base: "clean", ing: "cleaning", past: "cleaned" },
            { base: "dance", ing: "dancing", past: "danced" }, { base: "help", ing: "helping", past: "helped" }, { base: "wait", ing: "waiting", past: "waited" },
            { base: "start", ing: "starting", past: "started" }, { base: "finish", ing: "finishing", past: "finished" }, { base: "open", ing: "opening", past: "opened" },
            { base: "close", ing: "closing", past: "closed" }, { base: "visit", ing: "visiting", past: "visited" }, { base: "need", ing: "needing", past: "needed" },
            { base: "want", ing: "wanting", past: "wanted" }, { base: "like", ing: "liking", past: "liked" }, { base: "love", ing: "loving", past: "loved" }
        ];

        // --- HELPER FUNCTIONS ---
        const getRuleForTopic = (topicName) => topicName;

        const getRichTheory = (topicName) => {
            const t = topicName.toLowerCase();
            if (t.includes("past simple") || t.includes("irregular")) {
                return { title: "Past Simple", color: "blue", use: "Use for actions that started and finished in the past.", structure: [{ label: "Positive", formula: "Subject + Verb-ed (or irregular)", example: "I walked. / I went." }, { label: "Negative", formula: "Subject + did not + Verb (base)", example: "I did not go." }, { label: "Question", formula: "Did + Subject + Verb (base)?", example: "Did you go?" }], tips: ["Irregular verbs don't use -ed (go → went).", "Use with: yesterday, last year, in 1999."] };
            }
            if (t.includes("present simple")) {
                return { title: "Present Simple", color: "emerald", use: "Use for facts, habits, and regular routines.", structure: [{ label: "Positive", formula: "Subject + Verb (+s for He/She/It)", example: "I work. / She works." }, { label: "Negative", formula: "Subject + don't/doesn't + Verb", example: "I don't work. / She doesn't work." }, { label: "Question", formula: "Do/Does + Subject + Verb?", example: "Do you work?" }], tips: ["Remember 's' for 3rd person (he, she, it).", "Keywords: usually, always, every day."] };
            }
            if (t.includes("present continuous")) {
                return { title: "Present Continuous", color: "emerald", use: "Use for actions happening right now or temporary situations.", structure: [{ label: "Positive", formula: "Subj + am/is/are + Verb-ing", example: "I am eating." }, { label: "Negative", formula: "Subj + am/is/are not + Verb-ing", example: "He isn't sleeping." }, { label: "Question", formula: "Am/Is/Are + Subj + Verb-ing?", example: "Are they playing?" }], tips: ["Verbs like 'know' or 'like' (stative) aren't usually continuous.", "Keywords: now, at the moment."] };
            }
            if (t.includes("present perfect")) {
                return { title: "Present Perfect", color: "violet", use: "Use for past experiences (time not important) or actions with a result now.", structure: [{ label: "Positive", formula: "Subj + have/has + Participle", example: "I have finished." }, { label: "Negative", formula: "Subj + haven't/hasn't + Participle", example: "She hasn't eaten." }], tips: ["'Participle' is the 3rd column (go-went-gone).", "Keywords: ever, never, just, yet, already."] };
            }
            if (t.includes("future")) {
                return { title: "Future Forms", color: "cyan", use: "Different forms for different future meanings.", structure: [{ label: "Will", formula: "Predictions / Instant decisions", example: "I will help you." }, { label: "Going to", formula: "Plans / Evidence", example: "It is going to rain." }], tips: ["Use Present Continuous for fixed arrangements (appointments)."] };
            }
            if (t.includes("conditional")) {
                return { title: "Conditionals", color: "amber", use: "To talk about cause and effect or hypothetical situations.", structure: [{ label: "First", formula: "If + Present, ... Will + Verb", example: "If it rains, I will stay." }, { label: "Second", formula: "If + Past, ... Would + Verb", example: "If I were rich, I would travel." }], tips: ["Use comma if 'If' clause comes first."] };
            }
            if (t.includes("passive")) {
                return { title: "Passive Voice", color: "rose", use: "When the object is more important than the subject (who did it).", structure: [{ label: "General", formula: "Object + Be + Past Participle", example: "The pizza was eaten." }], tips: ["We use 'by' to say who did it (by the dog)."] };
            }
            return { title: "Grammar Rules", color: "slate", use: "Review the specific rules for this topic.", structure: [{ label: "Concept", formula: "Understand the meaning first", example: "-" }, { label: "Form", formula: "Check verb endings and auxiliaries", example: "-" }], tips: ["Practice makes perfect!"] };
        };

        const generateGrammarExercises = (topicName, count = 10) => {
            const t = topicName.toLowerCase();
            let exercises = [];
            const randSubj = () => SUBJECTS[Math.floor(Math.random() * SUBJECTS.length)];
            const randObj = () => OBJECTS[Math.floor(Math.random() * OBJECTS.length)];
            const randTimePast = () => TIME_PAST[Math.floor(Math.random() * TIME_PAST.length)];
            const randTimeFut = () => TIME_FUTURE[Math.floor(Math.random() * TIME_FUTURE.length)];
            const randTimeFreq = () => TIME_FREQ[Math.floor(Math.random() * TIME_FREQ.length)];
            const getUniqueVerbs = (list, num) => [...list].sort(() => 0.5 - Math.random()).slice(0, num);
            const toIng = (v) => {
                if(v.endsWith('e') && !v.endsWith('ee')) return v.slice(0,-1) + 'ing';
                if(["sit","run","swim","get","put","cut"].includes(v)) return v + v.slice(-1) + 'ing';
                return v + 'ing';
            };

            // Exercise logic (Condensed for brevity but functional)
            if (t.includes("past") || t.includes("irregular") || t.includes("did")) {
                const verbs = getUniqueVerbs(VERBS_IRREGULAR, count);
                verbs.forEach((v, i) => {
                    const s = randSubj();
                    let q = {};
                    if (t.includes("participle") || t.includes("perfect")) q = { text: `${s} has ___ (${v.base}) ${randObj()}.`, answer: v.pp };
                    else if (t.includes("negative")) q = { text: `${s} ___ (not / ${v.base}) ${randObj()} ${randTimePast()}.`, answer: `did not ${v.base}` };
                    else if (t.includes("question")) q = { text: `___ (${s} / ${v.base}) ${randObj()}?`, answer: `Did ${s.toLowerCase()} ${v.base}` };
                    else q = { text: `${randTimePast()}, ${s} ___ (${v.base}) ${randObj()}.`, answer: v.past };
                    exercises.push({ ...q, id: `past_${Date.now()}_${i}`, type: 'gap' });
                });
            } else if (t.includes("present simple")) {
                const verbs = getUniqueVerbs([...VERBS_REGULAR, ...VERBS_IRREGULAR], count);
                verbs.forEach((v, i) => {
                    const s = randSubj();
                    const is3rd = ["He","She","It","The student","My friend","The teacher","The doctor"].includes(s);
                    let q = {};
                    if (t.includes("negative")) { const aux = is3rd ? "does not" : "do not"; q = { text: `${s} ___ (not / ${v.base}) ${randObj()}.`, answer: `${aux} ${v.base}` }; }
                    else if (t.includes("question")) { const aux = is3rd ? "Does" : "Do"; q = { text: `___ (${s} / ${v.base}) ${randObj()}?`, answer: `${aux} ${s.toLowerCase()} ${v.base}` }; }
                    else { let ans = v.base; if(is3rd) { if(v.base === 'have') ans = 'has'; else if(v.base === 'be') ans = 'is'; else if(v.base.endsWith('o')||v.base.endsWith('ch')||v.base.endsWith('sh')) ans = v.base + 'es'; else ans = v.base + 's'; } else if(v.base === 'be') ans = (s === 'I' ? 'am' : 'are'); q = { text: `${s} ${randTimeFreq()} ___ (${v.base}) ${randObj()}.`, answer: ans }; }
                    exercises.push({ ...q, id: `pres_${Date.now()}_${i}`, type: 'gap' });
                });
            } else if (t.includes("present continuous")) {
                const verbs = getUniqueVerbs([...VERBS_REGULAR, ...VERBS_IRREGULAR].filter(v => v.base !== 'be' && v.base !== 'have'), count);
                verbs.forEach((v, i) => { const s = randSubj(); let be = "are"; if(s==="I") be="am"; else if(["He","She","It","The student","My friend"].some(x=>s.includes(x))) be="is"; exercises.push({ text: `Look! ${s} ___ (${v.base}) ${randObj()}.`, answer: `${be} ${toIng(v.base)}`, id: `cont_${i}`, type: 'gap' }); });
            } else if (t.includes("perfect")) {
                const verbs = getUniqueVerbs(VERBS_IRREGULAR, count);
                verbs.forEach((v, i) => { const s = randSubj(); const has = ["He","She","It","The student"].some(x=>s.includes(x)) ? "has" : "have"; exercises.push({ text: `${s} ___ (just / ${v.base}) ${randObj()}.`, answer: `${has} just ${v.pp}`, id: `perf_${i}`, type: 'gap' }); });
            } else if (t.includes("future")) {
                const verbs = getUniqueVerbs(VERBS_REGULAR, count);
                verbs.forEach((v, i) => { const s = randSubj(); exercises.push({ text: `I think ${s} ___ (${v.base}) ${randObj()} ${randTimeFut()}.`, answer: `will ${v.base}`, id: `fut_${i}`, type: 'gap' }); });
            } else if (t.includes("passive")) {
                 const pVerbs = getUniqueVerbs(VERBS_IRREGULAR.filter(v => ["write","eat","drink","buy","sell"].includes(v.base)), count);
                 pVerbs.forEach((v, i) => { const obj = ["The letter", "The car", "The house"][i % 3]; exercises.push({ text: `${obj} ___ (${v.base}) by ${randSubj().toLowerCase()}.`, answer: `was ${v.pp}`, id: `pass_${i}`, type: 'gap' }); });
            } else if (t.includes("preposition")) {
                const preps = [{t: "He is interested ___ art.", a: "in"}, {t: "She is good ___ math.", a: "at"}, {t: "Wait ___ me!", a: "for"}, {t: "Listen ___ the teacher.", a: "to"}];
                for(let i=0; i<count; i++) { const p = preps[i % preps.length]; exercises.push({ text: p.t, answer: p.a, id: `prep_${i}`, type: 'gap' }); }
            } else {
                const fallbackPool = [{t: "If I go, I ___ (see) him.", a: "will see"}, {t: "I enjoy ___ (read).", a: "reading"}, {t: "She decided ___ (go).", a: "to go"}];
                for(let i=0; i<count; i++) { const p = fallbackPool[i % fallbackPool.length]; exercises.push({ text: p.t, answer: p.a, id: `fall_${i}`, type: 'gap' }); }
            }
           
            exercises.sort(() => Math.random() - 0.5);
            return { exercises, theoryRule: getRuleForTopic(topicName) };
        };

        const GRAMMAR_LIBRARY = [
            { category: "1. Irregular Verbs & Past", count: 11, color: "blue", topics: ["Irregular Past Simple, Part 1", "Irregular Past Simple, Part 2", "Irregular Past Participle, Part 1", "Irregular Past Participle, Part 2", "Past Simple Positive (Irregular Verbs 1)", "Past Simple Positive (Irregular Verbs 2)", "Past Simple Negative", "Past Simple Yes / No Questions", "Past Simple Wh Questions", "Past Simple All Forms Mixed 1", "Past Simple All Forms Mixed 2"] },
            { category: "2. Present Tenses", count: 12, color: "emerald", topics: ["Present Simple Positive (be)", "Present Simple Negative (be)", "Present Simple Questions (be)", "Present Simple Mixed (be)", "Present Simple Positive (other verbs)", "Present Simple Negative (other verbs)", "Present Simple Questions (other verbs)", "Present Simple Mixed Forms", "Present Continuous Positive & Negative", "Present Continuous Questions", "Present Continuous Mixed", "Present Simple vs Present Continuous"] },
            { category: "3. Perfect Tenses", count: 9, color: "violet", topics: ["Present Perfect Positive", "Present Perfect Negative", "Present Perfect Questions", "Present Perfect Mixed", "Past Simple vs Present Perfect", "Present Perfect Continuous", "Present Perfect Simple vs Continuous", "Past Perfect Simple", "Past Perfect Continuous"] },
            { category: "4. Future Forms", count: 7, color: "cyan", topics: ["Future Simple", "Future Continuous", "Future Perfect", "Future Perfect Continuous", "Mixed Future Forms", "Future Simple vs Present Simple", "Negative Questions"] },
            { category: "5. Conditionals & Reported Speech", count: 7, color: "amber", topics: ["Zero Conditional", "First Conditional", "Second Conditional", "Third Conditional", "Mixed Conditionals", "Reported Speech (Statements)", "Reported Speech (Questions & Requests)"] },
            { category: "6. Passive & Modal Verbs", count: 7, color: "rose", topics: ["Passive – Present", "Passive – Past", "Passive – Perfect", "Passive – Future", "Passive – Mixed Forms", "Modal Verbs", "Modal Verbs (Probability & Obligation)"] },
            { category: "7. Advanced Structures (C1/C2)", count: 9, color: "fuchsia", topics: ["Relative Clauses", "Relative Pronouns", "Inversion", "Verb Patterns", "Causatives", "Embedded / Indirect Questions", "Gerunds & Infinitives", "Reflexive Pronouns", "Advanced Mixed Structures"] },
            { category: "8. Prepositions & Articles", count: 6, color: "slate", topics: ["Time Prepositions", "Place Prepositions", "Verbs + Prepositions", "Adjectives + Prepositions", "Articles (A / The / Zero Article)", "Linking Words"] }
        ];

        // --- COMPONENTS ---
        function Confetti() {
            const [particles, setParticles] = useState([]);
            useEffect(() => {
                setParticles(Array.from({ length: 50 }).map((_, i) => ({
                id: i, left: Math.random() * 100 + '%', bg: ['#3B82F6', '#8B5CF6', '#EC4899', '#10B981'][Math.floor(Math.random() * 4)],
                delay: Math.random() * 2 + 's', duration: Math.random() * 2 + 2 + 's'
                })));
            }, []);
            return <div className="fixed inset-0 pointer-events-none z-[100]">{particles.map(p => <div key={p.id} className="absolute w-2 h-2 rounded-sm" style={{ left: p.left, backgroundColor: p.bg, animation: `confetti-fall ${p.duration} linear ${p.delay} forwards` }} />)}</div>;
        }

        function IrregularVerbsList({ onClose }) {
            const [searchTerm, setSearchTerm] = useState("");
            const filteredVerbs = VERBS_IRREGULAR.filter(v =>
                v.base.includes(searchTerm.toLowerCase()) ||
                v.past.includes(searchTerm.toLowerCase()) ||
                v.pp.includes(searchTerm.toLowerCase())
            );
            return (
                <div className="fixed inset-0 bg-white z-[200] flex flex-col animate-smooth-view overflow-hidden">
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white shadow-sm z-10">
                        <h3 className="text-2xl font-black text-slate-800 flex items-center gap-3"><Icon name="list" className="text-blue-500" size={28} /> Irregular Verbs</h3>
                        <button onClick={onClose} className="p-3 hover:bg-slate-100 rounded-full transition-colors bg-slate-50"><Icon name="x" size={24} /></button>
                    </div>
                    <div className="p-6 bg-slate-50 border-b border-slate-200">
                        <div className="max-w-2xl mx-auto relative">
                            <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                            <input type="text" placeholder="Search verbs..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-12 pr-4 py-4 rounded-xl border-2 border-slate-200 focus:border-blue-500 outline-none font-bold text-lg transition-all" autoFocus />
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50">
                        <div className="max-w-4xl mx-auto">
                            <div className="grid grid-cols-3 font-black text-slate-400 text-xs md:text-sm uppercase tracking-widest mb-4 px-6"><span>Infinitive</span><span>Past Simple</span><span>Past Participle</span></div>
                            <div className="space-y-3">
                                {filteredVerbs.map((v, i) => (
                                    <div key={i} className="grid grid-cols-3 p-5 bg-white rounded-2xl border border-slate-100 shadow-sm hover:shadow-md items-center">
                                        <span className="font-black text-slate-800 text-lg">{v.base}</span><span className="text-blue-600 font-bold text-lg">{v.past}</span><span className="text-indigo-600 font-bold text-lg">{v.pp}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function TheoryCard({ topic, onStart }) {
            const data = getRichTheory(topic);
            return (
                <div className="glass-card p-8 rounded-[2.5rem] shadow-2xl relative animate-card overflow-hidden">
                    <div className={`absolute top-0 left-0 w-full h-3 bg-${data.color}-500`} />
                    <div className="mb-6">
                        <span className={`inline-block px-4 py-1 rounded-full text-xs font-black uppercase tracking-widest bg-${data.color}-100 text-${data.color}-700 mb-3`}>Grammar Rule</span>
                        <h3 className="text-3xl font-black text-slate-900">{data.title}</h3>
                        <p className="text-lg text-slate-500 mt-2 font-medium">{data.use}</p>
                    </div>
                    <div className="space-y-6">
                        {data.structure.map((item, idx) => (
                            <div key={idx} className="bg-slate-50 p-5 rounded-2xl border border-slate-100">
                                <div className={`text-xs font-black uppercase tracking-wider text-${data.color}-600 mb-1`}>{item.label}</div>
                                <div className="font-bold text-slate-800 text-lg mb-1">{item.formula}</div>
                                <div className="text-slate-500 italic">"{item.example}"</div>
                            </div>
                        ))}
                    </div>
                    <div className="mt-8 bg-yellow-50 p-5 rounded-2xl border border-yellow-100 flex gap-4 items-start">
                        <div className="bg-yellow-400 text-white p-2 rounded-lg mt-1"><Icon name="lightbulb" size={20} /></div>
                        <div>
                            <h4 className="font-bold text-yellow-800 mb-1">Pro Tips</h4>
                            <ul className="text-sm text-yellow-700 space-y-1 list-disc list-inside">
                                {data.tips.map((tip, i) => <li key={i}>{tip}</li>)}
                            </ul>
                        </div>
                    </div>
                    <button onClick={onStart} className="w-full mt-8 bg-slate-900 text-white py-5 rounded-2xl font-bold text-lg hover:scale-[1.02] active:scale-95 transition-all shadow-xl shadow-slate-200">Start Practice</button>
                </div>
            );
        }

        function PracticeView({ exercise, onAnswer }) {
            const [input, setInput] = useState('');
            const [status, setStatus] = useState('unanswered');
            const inputRef = useRef(null);
           
            if (!exercise) return <div className="text-center p-10 text-slate-400">Loading...</div>;

            useEffect(() => {
                setInput(''); setStatus('unanswered');
                const timer = setTimeout(() => { if(inputRef.current) inputRef.current.focus(); }, 10);
                return () => clearTimeout(timer);
            }, [exercise.id]);

            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === 'Enter') {
                        if (status === 'unanswered') { check(); } else { onAnswer(status === 'correct', input); }
                    }
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [status, input, exercise]);

            const check = () => {
                if (!input && exercise.type !== 'choice') return;
                const userVal = input.trim().toLowerCase();
                const correctVal = exercise.answer.toLowerCase();
                const isCorrect = userVal === correctVal;
                setStatus(isCorrect ? 'correct' : 'incorrect');
            };

            const handleNext = () => {
                onAnswer(status === 'correct', input);
            };

            return (
                <div className="glass-card p-8 md:p-12 rounded-[3rem] shadow-2xl animate-card text-center">
                    <h3 className="text-2xl font-bold mb-10 text-slate-800">{exercise.text}</h3>
                    <input key={exercise.id} ref={inputRef} type="text" value={input} disabled={status !== 'unanswered'} onChange={(e) => setInput(e.target.value)} placeholder="Type answer..." className={`w-full p-4 border-2 rounded-xl text-center font-bold text-xl outline-none transition-all ${status === 'correct' ? 'border-emerald-500 bg-emerald-50 text-emerald-700' : status === 'incorrect' ? 'border-red-500 bg-red-50 text-red-700' : 'focus:border-blue-500'}`} autoFocus />
                    <div className="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                        {status === 'correct' && (<div className="animate-pop"><div className="text-emerald-600 font-bold text-xl flex items-center gap-2 justify-center mb-2"><Icon name="check-circle" size={28} /> Correct!</div><button onClick={() => handleNext()} className="text-sm font-bold text-slate-400 bg-slate-100 px-4 py-2 rounded-full hover:bg-slate-200 transition-colors">Press Enter ↵</button></div>)}
                        {status === 'incorrect' && (<div className="animate-shake"><div className="text-red-500 font-bold text-xl flex items-center gap-2 justify-center mb-1"><Icon name="x-circle" size={28} /> Incorrect</div><div className="text-slate-600 font-medium mb-3">Correct answer: <span className="font-black text-slate-800">{exercise.answer}</span></div><button onClick={() => handleNext()} className="text-sm font-bold text-white bg-slate-900 px-6 py-2 rounded-full hover:scale-105 transition-all">Next (Enter ↵)</button></div>)}
                    </div>
                </div>
            );
        }

        function TestDetailView({ test, onBack, onRetry, isReadOnly = false }) {
            return (
                <div className="animate-smooth-view">
                    <button onClick={onBack} className="flex items-center gap-2 text-slate-400 hover:text-slate-700 font-bold mb-6 transition-colors"><Icon name="arrow-left" size={18} /> Back</button>
                    <div className="glass-card p-8 rounded-[2.5rem] mb-6">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <div>
                                <h2 className="text-2xl font-black text-slate-800">{test.topic || test.name + "'s Result"}</h2>
                                <p className="text-slate-400 text-sm">{test.date}</p>
                            </div>
                            <div className={`text-3xl font-black ${test.score === test.total ? 'text-emerald-500' : 'text-indigo-600'}`}>{test.score}/{test.total}</div>
                        </div>
                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2"><Icon name="alert-circle" size={20} className="text-red-500"/> Mistakes Review</h3>
                        <div className="space-y-4">
                            {test.mistakes && test.mistakes.length > 0 ? (
                                test.mistakes.map((m, i) => (
                                    <div key={i} className="bg-red-50 p-4 rounded-xl border border-red-100">
                                        <p className="font-bold text-slate-800 mb-2">{m.text}</p>
                                        <div className="flex justify-between items-center text-sm"><span className="text-red-500">Answer: <span className="line-through font-bold">{m.userAnswer || "—"}</span></span><span className="text-emerald-600 font-bold bg-emerald-50 px-2 py-1 rounded">Correct: {m.answer}</span></div>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-8 text-emerald-600 font-bold bg-emerald-50 rounded-2xl"><Icon name="check-circle" className="mx-auto mb-2" size={32} /> Perfect Score! No mistakes.</div>
                            )}
                        </div>
                        {!isReadOnly && test.mistakes && test.mistakes.length > 0 && (
                            <button onClick={() => onRetry(test.mistakes)} className="w-full mt-8 bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-indigo-200 flex items-center justify-center gap-2"><Icon name="refresh-cw" size={20} /> Retry Mistakes</button>
                        )}
                    </div>
                </div>
            );
        }
       
        function LoginView() {
            const handleGoogleLogin = async () => {
                if (!auth) {
                    alert("Firebase is not configured. Please add your credentials in the index.html file.");
                    return;
                }
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.warn("Google Sign-In failed or not authorized. Falling back to anonymous login.");
                    try {
                        const result = await signInAnonymously(auth);
                        await updateProfile(result.user, {
                            displayName: "Demo User",
                            photoURL: "https://ui-avatars.com/api/?name=Demo+User&background=random&color=fff"
                        });
                    } catch (fallbackError) {
                        console.error("Login completely failed", fallbackError);
                        alert("Login failed. Please check your internet connection.");
                    }
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 animate-smooth-view">
                    <div className="glass-card p-12 rounded-[3rem] text-center max-w-md w-full">
                        <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-6">
                            <Icon name="zap" size={40} className="text-white" />
                        </div>
                        <h1 className="text-4xl md:text-5xl font-black text-slate-800 mb-2">Clear English</h1>
                        <p className="text-slate-400 font-bold mb-10">Sign in to start learning</p>
                       
                        <button onClick={handleGoogleLogin} className="w-full bg-white border-2 border-slate-100 p-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-slate-700 hover:bg-slate-50 hover:border-blue-200 hover:scale-105 transition-all shadow-lg shadow-slate-200/50 group">
                            <svg className="w-6 h-6" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Sign in with Google
                        </button>
                    </div>
                </div>
            );
        }

        function AuthView({ onSelectRole }) {
            return (
                <div className="min-h-screen flex items-center justify-center p-4 animate-smooth-view">
                    <div className="glass-card p-12 rounded-[3rem] text-center max-w-2xl w-full relative">
                        <div className="absolute top-6 right-6 flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100">
                            {auth?.currentUser?.photoURL && <img src={auth.currentUser.photoURL} className="w-6 h-6 rounded-full" />}
                            <span className="text-xs font-bold text-slate-500">{auth?.currentUser?.displayName}</span>
                            <button onClick={() => auth?.signOut()} className="text-xs text-red-500 font-bold ml-2 hover:underline">Logout</button>
                        </div>
                       
                        <div className="mb-10">
                             <div className="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl mx-auto flex items-center justify-center shadow-lg shadow-blue-500/30 mb-6">
                                <Icon name="zap" size={40} className="text-white" />
                            </div>
                            <h1 className="text-4xl md:text-5xl font-black text-slate-800 mb-2">Clear English</h1>
                            <p className="text-slate-400 font-bold">Select your profile</p>
                        </div>
                       
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button onClick={() => onSelectRole('student')} className="p-8 rounded-[2.5rem] bg-indigo-50 border-2 border-indigo-100 hover:bg-indigo-100 hover:scale-105 transition-all group">
                                <Icon name="graduation-cap" size={48} className="mx-auto text-indigo-600 mb-4 group-hover:scale-110 transition-transform" />
                                <h3 className="text-2xl font-black text-indigo-800">Student</h3>
                            </button>
                            <button onClick={() => onSelectRole('teacher-login')} className="p-8 rounded-[2.5rem] bg-blue-50 border-2 border-blue-100 hover:bg-blue-100 hover:scale-105 transition-all group">
                                <Icon name="presentation" size={48} className="mx-auto text-blue-600 mb-4 group-hover:scale-110 transition-transform" />
                                <h3 className="text-2xl font-black text-blue-800">Teacher</h3>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function TeacherLogin({ onLogin, onBack }) {
            const [pass, setPass] = useState('');
            const [error, setError] = useState(false);
           
            const handleLogin = () => {
                if (pass === 'ADMIN2235') {
                    onLogin();
                } else {
                    setError(true);
                    setTimeout(() => setError(false), 2000);
                }
            };
           
            return (
                <div className="min-h-screen flex items-center justify-center p-4 animate-smooth-view">
                     <div className="glass-card p-10 rounded-[2.5rem] text-center max-w-md w-full relative">
                        <button onClick={onBack} className="absolute top-6 left-6 text-slate-400 hover:text-slate-600"><Icon name="arrow-left" /></button>
                        <h2 className="text-3xl font-black text-slate-800 mb-8 mt-4">Teacher Access</h2>
                        <input
                            type="password"
                            placeholder="Enter Password"
                            className="w-full p-4 mb-4 bg-slate-50 border-2 border-slate-200 rounded-xl outline-none focus:border-blue-500 font-bold text-center text-lg"
                            value={pass}
                            onChange={(e) => setPass(e.target.value)}
                        />
                        {error && <div className="text-red-500 font-bold mb-4 animate-shake">Incorrect Password</div>}
                        <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-colors">Enter Dashboard</button>
                     </div>
                </div>
            );
        }

        function TeacherDashboard({ onLogout }) {
            const [activeTab, setActiveTab] = useState('create-party');
            const [selectedTopics, setSelectedTopics] = useState([]);
            const [generatedCode, setGeneratedCode] = useState(null);
            const [classResults, setClassResults] = useState([]);
            const [viewingResult, setViewingResult] = useState(null);
            const [previewTopic, setPreviewTopic] = useState(null);
            const [lastSeenCount, setLastSeenCount] = useState(() => parseInt(localStorage.getItem('teacher_last_seen_count') || '0'));
           
            const allTopics = GRAMMAR_LIBRARY.flatMap(g => g.topics);
           
            useEffect(() => {
                const savedResults = localStorage.getItem('class_results');
                if (savedResults) {
                    setClassResults(JSON.parse(savedResults));
                }
            }, [activeTab]);

            const newResultsCount = classResults.length - lastSeenCount;

            const handleTabChange = (tab) => {
                setActiveTab(tab);
                if (tab === 'results') {
                    const currentCount = classResults.length;
                    setLastSeenCount(currentCount);
                    localStorage.setItem('teacher_last_seen_count', currentCount);
                }
            };

            const toggleTopic = (t) => {
                if(selectedTopics.includes(t)) setSelectedTopics(prev => prev.filter(i => i !== t));
                else setSelectedTopics(prev => [...prev, t]);
            };
           
            const createParty = () => {
                if(selectedTopics.length === 0) return;
                const code = Math.random().toString(36).substring(2, 8).toUpperCase();
                setGeneratedCode(code);
                localStorage.setItem(`fastparty_${code}`, JSON.stringify(selectedTopics));
            };

            return (
                <div className="animate-smooth-view min-h-screen p-6">
                    <div className="max-w-5xl mx-auto">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <h2 className="text-3xl font-black text-slate-800 flex items-center gap-3"><Icon name="layout-dashboard" className="text-blue-600" /> Teacher Dashboard</h2>
                            <div className="flex gap-2">
                                <button onClick={() => handleTabChange('create-party')} className={`px-4 py-2 rounded-xl font-bold transition-all flex items-center gap-2 ${activeTab === 'create-party' ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'bg-white text-slate-500 hover:bg-slate-100'}`}><Icon name="party-popper" size={18}/> Launch Party</button>
                               
                                <button onClick={() => handleTabChange('results')} className={`px-4 py-2 rounded-xl font-bold transition-all flex items-center gap-2 relative ${activeTab === 'results' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' : 'bg-white text-slate-500 hover:bg-slate-100'}`}>
                                    <Icon name="bar-chart-2" size={18}/> Student Results
                                    {newResultsCount > 0 && activeTab !== 'results' && (
                                        <span className="absolute -top-1 -right-1 flex h-4 w-4">
                                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                          <span className="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-[10px] text-white justify-center items-center">{newResultsCount}</span>
                                        </span>
                                    )}
                                </button>
                               
                                <button onClick={() => handleTabChange('curriculum')} className={`px-4 py-2 rounded-xl font-bold transition-all flex items-center gap-2 ${activeTab === 'curriculum' ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-200' : 'bg-white text-slate-500 hover:bg-slate-100'}`}><Icon name="book" size={18}/> Curriculum</button>
                                <button onClick={onLogout} className="ml-4 text-slate-400 font-bold hover:text-red-500 flex items-center gap-2 transition-colors"><Icon name="log-out" size={18}/> Logout</button>
                            </div>
                        </div>
                       
                        {activeTab === 'create-party' && (
                            <div className="grid md:grid-cols-2 gap-6 animate-smooth-view">
                                {/* LEFT: Creator */}
                                <div className="glass-card p-6 rounded-[2rem] h-[600px] flex flex-col">
                                    <h3 className="font-bold text-xl mb-4 text-slate-700">1. Select Topics for Quiz</h3>
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                                        {allTopics.map((t, i) => (
                                            <div key={i} onClick={() => toggleTopic(t)} className={`p-3 rounded-xl border-2 cursor-pointer flex items-center justify-between transition-all ${selectedTopics.includes(t) ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100 hover:border-blue-200'}`}>
                                                <span className="font-bold text-sm text-slate-700">{t}</span>
                                                {selectedTopics.includes(t) && <Icon name="check" size={16} className="text-emerald-500" />}
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-slate-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <span className="font-bold text-slate-400">{selectedTopics.length} selected</span>
                                            <button onClick={() => setSelectedTopics([])} className="text-xs font-bold text-slate-400 hover:text-slate-600">Clear all</button>
                                        </div>
                                        <button onClick={createParty} disabled={selectedTopics.length === 0} className={`w-full py-4 rounded-xl font-bold text-white transition-all ${selectedTopics.length > 0 ? 'bg-indigo-600 hover:bg-indigo-700 shadow-lg shadow-indigo-200' : 'bg-slate-300 cursor-not-allowed'}`}>Generate Party Code</button>
                                    </div>
                                </div>
                               
                                {/* RIGHT: Status */}
                                <div className="flex flex-col gap-6">
                                    <div className="glass-card p-8 rounded-[2rem] text-center bg-gradient-to-br from-indigo-600 to-purple-700 text-white relative overflow-hidden">
                                         <div className="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                                         <h3 className="font-bold text-indigo-100 mb-2 uppercase tracking-widest text-sm">Active Party Code</h3>
                                         {generatedCode ? (
                                             <div className="animate-pop">
                                                 <div className="text-6xl font-black mb-2 tracking-widest">{generatedCode}</div>
                                                 <div className="text-indigo-200 text-sm">Share this code with your students</div>
                                             </div>
                                         ) : (
                                             <div className="text-indigo-300 italic py-6">Select topics and click generate...</div>
                                         )}
                                    </div>
                                   
                                    <div className="glass-card p-6 rounded-[2rem] flex-1 flex flex-col justify-center items-center text-center">
                                        <Icon name="users" size={48} className="text-slate-300 mb-4" />
                                        <h3 className="font-bold text-slate-700 mb-2">Ready for Students</h3>
                                        <p className="text-slate-400 text-sm max-w-xs">Once students finish the quiz using the code, their results will appear in the "Student Results" tab.</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'results' && !viewingResult && (
                            <div className="glass-card p-8 rounded-[2.5rem] animate-smooth-view">
                                <h3 className="font-black text-2xl mb-6 text-slate-800">Student Results</h3>
                                {classResults.length === 0 ? (
                                    <div className="text-center py-20 text-slate-400">
                                        <Icon name="clipboard-list" size={64} className="mx-auto mb-4 opacity-20" />
                                        <p>No results yet. Launch a Fast Party to get started!</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead>
                                                <tr className="border-b-2 border-slate-100">
                                                    <th className="pb-4 font-black text-slate-400 text-xs uppercase tracking-wider">Student Name</th>
                                                    <th className="pb-4 font-black text-slate-400 text-xs uppercase tracking-wider">Date</th>
                                                    <th className="pb-4 font-black text-slate-400 text-xs uppercase tracking-wider">Code Used</th>
                                                    <th className="pb-4 font-black text-slate-400 text-xs uppercase tracking-wider text-right">Score</th>
                                                    <th className="pb-4 w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-50">
                                                {classResults.map((res, i) => (
                                                    <tr key={i} onClick={() => setViewingResult(res)} className="hover:bg-slate-50/80 transition-colors cursor-pointer group">
                                                        <td className="py-4 font-bold text-slate-800 group-hover:text-blue-600 transition-colors">{res.name}</td>
                                                        <td className="py-4 text-slate-500 text-sm">{res.date}</td>
                                                        <td className="py-4 text-slate-500 font-mono text-xs"><span className="bg-slate-100 px-2 py-1 rounded">{res.code}</span></td>
                                                        <td className="py-4 text-right">
                                                            <span className={`px-3 py-1 rounded-full text-sm font-black ${res.score === res.total ? 'bg-emerald-100 text-emerald-700' : 'bg-indigo-100 text-indigo-700'}`}>
                                                                {res.score} / {res.total}
                                                            </span>
                                                        </td>
                                                        <td className="py-4 text-right text-slate-300 group-hover:text-blue-400"><Icon name="chevron-right" size={20}/></td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        )}
                       
                        {activeTab === 'results' && viewingResult && (
                            <TestDetailView test={viewingResult} onBack={() => setViewingResult(null)} isReadOnly={true} />
                        )}

                        {activeTab === 'curriculum' && (
                            <div className="space-y-6 animate-smooth-view">
                                {GRAMMAR_LIBRARY.map((group, idx) => (
                                    <div key={idx} className="glass-card p-6 rounded-[2rem]">
                                        <div className="flex items-center gap-3 mb-4">
                                            <div className={`w-3 h-3 rounded-full bg-${group.color}-500`}></div>
                                            <h3 className="font-black text-xl text-slate-800">{group.category}</h3>
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {group.topics.map((t, i) => (
                                                <button key={i} onClick={() => setPreviewTopic(t)} className="px-3 py-1 bg-slate-50 border border-slate-100 rounded-lg text-sm text-slate-600 font-medium hover:bg-white hover:border-blue-300 hover:text-blue-600 transition-all">
                                                    {t}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                       
                        {/* Topic Preview Modal */}
                        {previewTopic && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm animate-smooth-view" onClick={() => setPreviewTopic(null)}>
                                <div className="bg-white rounded-[2rem] p-8 max-w-lg w-full shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                    <button onClick={() => setPreviewTopic(null)} className="absolute top-6 right-6 text-slate-300 hover:text-slate-500"><Icon name="x" /></button>
                                    <h3 className="font-black text-2xl text-slate-800 mb-6">{previewTopic}</h3>
                                    <p className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4">Example Questions</p>
                                    <div className="space-y-3 max-h-[400px] overflow-y-auto">
                                        {generateGrammarExercises(previewTopic, 5).exercises.map((ex, i) => (
                                            <div key={i} className="bg-slate-50 p-4 rounded-xl text-sm font-medium text-slate-700">
                                                {ex.text}
                                                <div className="mt-2 text-xs text-indigo-500 font-bold">Answer: {ex.answer}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- FAST PARTY HELPER (UPDATED) ---
        const generateFastPartyMix = (customTopics = null) => {
            let topicsToUse = [];
            if (customTopics && customTopics.length > 0) {
                topicsToUse = customTopics;
            } else {
                const allTopics = GRAMMAR_LIBRARY.flatMap(g => g.topics);
                while(topicsToUse.length < 3) {
                    const t = allTopics[Math.floor(Math.random() * allTopics.length)];
                    if(!topicsToUse.includes(t)) topicsToUse.push(t);
                }
            }
            let mixedExercises = [];
            topicsToUse.forEach(t => {
                const data = generateGrammarExercises(t, 5);
                mixedExercises = [...mixedExercises, ...data.exercises];
            });
            return mixedExercises.sort(() => Math.random() - 0.5).slice(0, 10);
        };

        function App() {
            const [userRole, setUserRole] = useState('none');
            const [user, setUser] = useState(null);
            const [view, setView] = useState('landing');
            const [appMode, setAppMode] = useState('practice');
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [currentTopic, setCurrentTopic] = useState(null);
            const [logoAnim, setLogoAnim] = useState(false);
            const [exercises, setExercises] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [showConfetti, setShowConfetti] = useState(false);
            const [showVerbsList, setShowVerbsList] = useState(false);
            const [currentMistakes, setCurrentMistakes] = useState([]);
            const [selectedTest, setSelectedTest] = useState(null);
            const [studentName, setStudentName] = useState('');
            const [teacherCode, setTeacherCode] = useState('');
            const [isFastParty, setIsFastParty] = useState(false);
            const [partyError, setPartyError] = useState('');
            const [history, setHistory] = useState(() => {
                try { const saved = localStorage.getItem('eng_history'); return saved ? JSON.parse(saved) : []; } catch(e){ return []; }
            });

            useEffect(() => {
                if(auth) {
                    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                        setUser(currentUser);
                        if (currentUser && !studentName) {
                            setStudentName(currentUser.displayName || "");
                        }
                    });
                    return () => unsubscribe();
                } else {
                    // DEMO MODE AUTO-LOGIN
                    setUser({ displayName: "Demo User", photoURL: null });
                    setStudentName("Demo User");
                }
            }, []);

            const saveResult = (topic, score, total, mistakes) => {
                const newRecord = { id: Date.now(), date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), topic, score, total, mistakes: mistakes || [] };
                const updatedHistory = [newRecord, ...history].slice(0, 50);
                setHistory(updatedHistory);
                localStorage.setItem('eng_history', JSON.stringify(updatedHistory));
            };

            const handleModeChange = (mode) => {
                if (appMode === mode && view === 'home' && !selectedGroup) {
                    setView('loading'); setTimeout(() => setView('home'), 10);
                } else {
                    setAppMode(mode); setView(mode === 'stats' ? 'stats' : 'home'); setSelectedGroup(null); setCurrentTopic(null);
                }
            };
           
            const handleFastPartyStart = () => {
                if (!studentName || !teacherCode) return;
                setPartyError('');
                const storedConfig = localStorage.getItem(`fastparty_${teacherCode.trim().toUpperCase()}`);
                let mix = [];
                if (storedConfig) {
                    try {
                        const topics = JSON.parse(storedConfig);
                        mix = generateFastPartyMix(topics);
                        setCurrentTopic(`Fast Party (${teacherCode})`);
                    } catch (e) {
                        setPartyError("Invalid Code Configuration.");
                        return;
                    }
                } else {
                    setPartyError("Code not found. Please ask your teacher.");
                    return;
                }
                setIsFastParty(true);
                setExercises(mix);
                setQIndex(0);
                setScore(0);
                setCurrentMistakes([]);
                setView('practice');
            };

            const handleTopicSelect = (topicName) => {
                setCurrentTopic(topicName);
                setIsFastParty(false);
                if (appMode === 'practice') {
                     const data = generateGrammarExercises(topicName, 10);
                     setExercises(data.exercises);
                     setQIndex(-1);
                     setScore(0);
                     setCurrentMistakes([]);
                     setView('practice');
                } else {
                     setView('theory-view');
                }
            };

            const handleRetryMistakes = (mistakesToRetry) => {
                const retryExercises = mistakesToRetry.map(m => ({ ...m, id: `retry_${m.id}_${Date.now()}` }));
                setExercises(retryExercises);
                setCurrentTopic(`Review: ${selectedTest.topic}`);
                setQIndex(0);
                setScore(0);
                setCurrentMistakes([]);
                setView('practice');
            };
           
            if (!user) {
                return (
                    <div className="min-h-screen font-sans text-slate-900 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 selection:bg-indigo-200">
                        <LoginView />
                    </div>
                );
            }

            if (userRole === 'none') {
                return (
                    <div className="min-h-screen font-sans text-slate-900 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 selection:bg-indigo-200">
                        <AuthView onSelectRole={(role) => setUserRole(role)} />
                    </div>
                );
            }
           
            if (userRole === 'teacher-login') {
                return (
                    <div className="min-h-screen font-sans text-slate-900 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 selection:bg-indigo-200">
                         <TeacherLogin onLogin={() => setUserRole('teacher-dashboard')} onBack={() => setUserRole('none')} />
                    </div>
                );
            }
           
            if (userRole === 'teacher-dashboard') {
                return (
                    <div className="min-h-screen font-sans text-slate-900 bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 selection:bg-indigo-200">
                        <TeacherDashboard onLogout={() => setUserRole('none')} />
                    </div>
                );
            }

            const totalScore = history.reduce((acc, curr) => acc + curr.score, 0);
            const totalPossible = history.reduce((acc, curr) => acc + curr.total, 0);
            const avgPercentage = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
            const animationKey = view + appMode + (selectedGroup ? selectedGroup.category : '') + (currentTopic || '') + (selectedTest ? selectedTest.id : '');

            return (
                <div className="min-h-screen font-sans text-slate-900 pb-12 overflow-x-hidden selection:bg-indigo-200">
                    {showConfetti && <Confetti />}
                    {showVerbsList && <IrregularVerbsList onClose={() => setShowVerbsList(false)} />}

                    <nav className="sticky top-4 z-40 mx-4 max-w-5xl md:mx-auto">
                        <div className="glass-panel rounded-2xl px-6 py-4 flex justify-between items-center shadow-lg shadow-blue-900/5">
                            <div className="flex items-center gap-3 cursor-pointer group" onClick={() => { setLogoAnim(true); setTimeout(() => setLogoAnim(false), 600); setView('landing'); setSelectedGroup(null); }}>
                                <div className={`bg-gradient-to-br from-blue-600 to-indigo-600 text-white p-2.5 rounded-xl shadow-lg shadow-blue-500/30 transition-transform ${logoAnim ? 'animate-lightning' : 'group-hover:scale-105'}`}>
                                    <Icon name="zap" size={20} fill="white" className="text-white" />
                                </div>
                                <h1 className="text-xl font-black tracking-tight bg-gradient-to-r from-blue-700 to-indigo-700 gradient-text hidden sm:block">Clear English</h1>
                            </div>
                           
                            <div className="flex gap-2 text-sm font-bold text-slate-500 overflow-x-auto items-center">
                                <button onClick={() => handleModeChange('theory')} className={`px-4 py-2 rounded-xl transition-all whitespace-nowrap ${appMode === 'theory' && view !== 'landing' ? 'bg-blue-100 text-blue-700' : 'hover:bg-slate-100'}`}>Theory</button>
                                <button onClick={() => handleModeChange('practice')} className={`px-4 py-2 rounded-xl transition-all whitespace-nowrap ${appMode === 'practice' && view !== 'landing' ? 'bg-indigo-100 text-indigo-700' : 'hover:bg-slate-100'}`}>Practice</button>
                                <button onClick={() => handleModeChange('stats')} className={`px-4 py-2 rounded-xl transition-all whitespace-nowrap flex items-center gap-1 ${appMode === 'stats' ? 'bg-emerald-100 text-emerald-700' : 'hover:bg-slate-100'}`}><Icon name="bar-chart-3" size={16} /> Stats</button>
                               
                                <div className="ml-2 flex items-center gap-2 bg-white pl-1 pr-3 py-1 rounded-full border border-slate-100 shadow-sm">
                                    {user.photoURL ? <img src={user.photoURL} className="w-6 h-6 rounded-full" /> : <div className="w-6 h-6 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs">{user.displayName?.[0]}</div>}
                                    <button onClick={() => setUserRole('none')} className="text-slate-400 hover:text-slate-600" title="Switch Role"><Icon name="users" size={16} /></button>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main key={animationKey} className="max-w-4xl mx-auto px-4 mt-8 relative animate-smooth-view">
                        {view === 'landing' && (
                            <div className="animate-card">
                                <div className="glass-card p-10 rounded-[2.5rem] mb-12 text-center relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-indigo-500" />
                                    <h2 className="text-4xl md:text-5xl font-black text-slate-800 mb-6 tracking-tight">Learn Fast. <span className="text-blue-600">English is Clear.</span></h2>
                                    <p className="text-lg text-slate-500 max-w-2xl mx-auto mb-10 font-medium leading-relaxed">The best place to practice your English. Clear theory, unlimited exercises.</p>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto">
                                        <button onClick={() => handleModeChange('theory')} className="p-6 bg-blue-50 rounded-[2rem] border border-blue-100 hover:shadow-xl hover:scale-105 transition-all group flex flex-col items-center justify-center gap-4">
                                            <Icon name="book-open" className="text-blue-600 group-hover:scale-110 transition-transform" size={40} />
                                            <h3 className="font-black text-slate-800 text-xl">Theory</h3>
                                        </button>
                                        <button onClick={() => handleModeChange('practice')} className="p-6 bg-indigo-50 rounded-[2rem] border border-indigo-100 hover:shadow-xl hover:scale-105 transition-all group flex flex-col items-center justify-center gap-4">
                                            <Icon name="check-circle" className="text-indigo-600 group-hover:scale-110 transition-transform" size={40} />
                                            <h3 className="font-black text-slate-800 text-xl">Practice</h3>
                                        </button>
                                        <button onClick={() => setView('fast-party-entry')} className="p-6 bg-pink-50 rounded-[2rem] border border-pink-100 hover:shadow-xl hover:scale-105 transition-all group flex flex-col items-center justify-center gap-4 relative overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-br from-pink-100/50 to-transparent pointer-events-none"></div>
                                            <Icon name="party-popper" className="text-pink-600 group-hover:scale-110 transition-transform animate-bounce" size={40} />
                                            <h3 className="font-black text-pink-700 text-xl">Fast Party 🎉</h3>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                       
                        {view === 'fast-party-entry' && (
                            <div className="animate-pop glass-card p-10 rounded-[2.5rem] max-w-xl mx-auto text-center mt-10">
                                <h2 className="text-3xl font-black mb-6 text-slate-800">Fast Party 🎉</h2>
                                <p className="text-slate-500 mb-8 font-medium">Enter your name and your teacher's code to start the challenge!</p>
                               
                                <input
                                    type="text"
                                    placeholder="Your Name"
                                    value={studentName}
                                    onChange={(e) => setStudentName(e.target.value)}
                                    className="w-full p-4 mb-4 border-2 border-pink-100 rounded-2xl focus:outline-none focus:border-pink-400 transition-all font-bold text-center text-lg"
                                />
                               
                                <input
                                    type="text"
                                    placeholder="Teacher Code"
                                    value={teacherCode}
                                    onChange={(e) => setTeacherCode(e.target.value)}
                                    className="w-full p-4 mb-4 border-2 border-pink-100 rounded-2xl focus:outline-none focus:border-pink-400 transition-all font-bold text-center text-lg uppercase tracking-widest"
                                />
                               
                                {partyError && <div className="text-red-500 font-bold mb-4 animate-shake">{partyError}</div>}
                               
                                <button
                                    onClick={handleFastPartyStart}
                                    disabled={!studentName || !teacherCode}
                                    className={`w-full bg-pink-600 text-white px-8 py-5 rounded-2xl font-bold text-lg hover:scale-105 hover:shadow-xl transition-all shadow-pink-200 ${(!studentName || !teacherCode) ? 'opacity-50 cursor-not-allowed' : ''}`}>
                                    Start Party 🚀
                                </button>
                               
                                <button
                                    onClick={() => setView('landing')}
                                    className="block mx-auto mt-6 text-slate-400 hover:text-slate-600 font-bold transition">
                                    ← Back
                                </button>
                            </div>
                        )}

                        {view === 'stats' && (
                            <div className="animate-card max-w-2xl mx-auto">
                                <h2 className="text-3xl font-black text-center mb-8 flex items-center justify-center gap-2"><Icon name="trophy" className="text-yellow-500" /> My Progress</h2>
                                <div className="grid grid-cols-2 gap-4 mb-8">
                                    <div className="glass-card p-6 rounded-[2rem] text-center"><div className="text-4xl font-black text-indigo-600 mb-1">{history.length}</div><div className="text-sm text-slate-500 font-bold uppercase tracking-wide">Tests Taken</div></div>
                                    <div className="glass-card p-6 rounded-[2rem] text-center"><div className="text-4xl font-black text-emerald-600 mb-1">{avgPercentage}/100</div><div className="text-sm text-slate-500 font-bold uppercase tracking-wide">Avg. Score</div></div>
                                </div>
                                {history.length > 0 && (
                                    <div className="glass-card p-8 rounded-[2.5rem] mb-8">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name="trending-up" size={20} className="text-blue-500"/> Performance Trend</h3>
                                        <div className="flex h-48 relative">
                                            <div className="flex flex-col justify-between text-xs font-bold text-slate-300 pr-2 py-2"><span>100%</span><span>50%</span><span>0%</span></div>
                                            <div className="flex-1 flex items-end justify-between relative border-l-2 border-slate-100 pl-2">
                                                <div className="absolute inset-0 border-t border-b border-dashed border-slate-100 pointer-events-none top-2 bottom-2"></div>
                                                <div className="absolute top-1/2 left-0 right-0 border-t border-dashed border-slate-100 pointer-events-none"></div>
                                                <svg className="w-full h-full absolute inset-0 overflow-visible z-10" preserveAspectRatio="none" viewBox={`0 0 100 100`}>
                                                    <polyline points={history.slice(0, 10).reverse().map((h, i, arr) => { const x = arr.length > 1 ? (i / (arr.length - 1)) * 100 : 50; const y = 100 - ((h.score / h.total) * 100); return `${x},${y}`; }).join(' ')} fill="none" stroke="#6366f1" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" vectorEffect="non-scaling-stroke" />
                                                </svg>
                                                <div className="absolute inset-0 flex justify-between items-center z-20 pointer-events-none">
                                                    {history.slice(0, 10).reverse().map((h, i, arr) => {
                                                        const pct = (h.score / h.total) * 100;
                                                        const colorClass = pct >= 80 ? 'bg-emerald-400 ring-emerald-200' : pct >= 50 ? 'bg-yellow-400 ring-yellow-200' : 'bg-red-400 ring-red-200';
                                                        const leftPos = arr.length > 1 ? (i / (arr.length - 1)) * 100 : 50;
                                                        return <div key={i} className={`w-3 h-3 rounded-full ring-4 ${colorClass} transition-all absolute group pointer-events-auto`} style={{ left: `${leftPos}%`, bottom: `${pct}%`, transform: 'translate(-50%, 50%)' }}><div className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[10px] font-bold px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">{h.score}/{h.total}</div></div>;
                                                    })}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="text-center text-xs text-slate-400 mt-4 font-bold uppercase tracking-widest">Last 10 Tests</div>
                                    </div>
                                )}
                                <div className="glass-card p-8 rounded-[2.5rem]"><h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name="history" size={20} className="text-slate-500"/> Recent Activity</h3><div className="space-y-4">{history.length === 0 ? <p className="text-center text-slate-400 py-4">No tests taken yet. Start practicing!</p> : history.map((item) => (<div key={item.id} onClick={() => { setSelectedTest(item); setView('test-detail'); }} className="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:bg-slate-50 transition-all hover:scale-[1.01]"><div><div className="font-bold text-slate-800 text-sm">{item.topic}</div><div className="text-xs text-slate-400">{item.date}</div></div><div className="flex items-center gap-3"><div className={`font-black text-lg ${item.score === item.total ? 'text-emerald-500' : 'text-indigo-600'}`}>{item.score}/{item.total}</div><Icon name="chevron-right" size={16} className="text-slate-300" /></div></div>))}</div></div>
                            </div>
                        )}

                        {view === 'test-detail' && selectedTest && (
                            <TestDetailView test={selectedTest} onBack={() => { setView('stats'); setSelectedTest(null); }} onRetry={(mistakes) => handleRetryMistakes(mistakes)} />
                        )}

                        {view === 'home' && !selectedGroup && (
                            <div className="animate-smooth-view">
                                <div className="text-center mb-10"><span className="inline-block px-4 py-1 rounded-full text-xs font-black uppercase tracking-widest mb-4 bg-indigo-100 text-indigo-700">Learning Path</span><h2 className="text-4xl font-black text-slate-800 mb-3">Choose a Level</h2><p className="text-slate-500 font-medium text-lg">Select a category to view the grammar topics.</p></div>
                                {appMode === 'theory' && (
                                    <div className="flex justify-center mb-10 animate-pop"><button onClick={() => setShowVerbsList(true)} className="flex items-center gap-2 bg-white px-8 py-4 rounded-full shadow-xl shadow-blue-100 border border-slate-100 font-bold text-slate-700 hover:text-blue-600 hover:scale-105 transition-all text-lg"><Icon name="file-text" size={20} /> 📄 Full Irregular Verbs List</button></div>
                                )}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {GRAMMAR_LIBRARY.map((group, idx) => (
                                        <button key={idx} onClick={() => setSelectedGroup(group)} className="group relative overflow-hidden rounded-[2.5rem] bg-white shadow-xl shadow-slate-200/50 hover:shadow-2xl hover:-translate-y-1 transition-all p-8 border border-slate-100 text-left">
                                            <div className="flex justify-between items-start mb-2"><h3 className={`text-2xl font-bold text-slate-800`}>{group.category}</h3><span className={`text-xs font-black px-3 py-1 rounded-full bg-${group.color}-100 text-${group.color}-600`}>{group.count} topics</span></div>
                                            <div className={`mt-6 flex items-center gap-2 font-bold text-sm text-${group.color}-600`}>Explore Topics <Icon name="chevron-right" size={16} /></div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'home' && selectedGroup && (
                            <div className="animate-smooth-view">
                                <button onClick={() => setSelectedGroup(null)} className="flex items-center gap-2 text-slate-400 hover:text-slate-700 font-bold mb-6 transition-colors"><Icon name="arrow-left" size={18} /> Back to Levels</button>
                                <h2 className="text-3xl font-black text-slate-800 mb-8">{selectedGroup.category}</h2>
                                <div className="grid gap-4">
                                    {selectedGroup.topics.map((topic, idx) => (
                                        <button key={idx} onClick={() => handleTopicSelect(topic)} className="flex items-center justify-between bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-lg hover:scale-[1.01] hover:border-blue-200 transition-all text-left group animate-stagger-item" style={{ animationDelay: `${idx * 0.05}s` }}>
                                            <div className="flex items-center gap-5"><div className={`w-10 h-10 rounded-full flex items-center justify-center font-black text-sm bg-${selectedGroup.color}-50 text-${selectedGroup.color}-600 group-hover:bg-${selectedGroup.color}-500 group-hover:text-white transition-colors`}>{idx + 1}</div><h4 className="text-lg font-bold text-slate-700 group-hover:text-slate-900 transition-colors">{topic}</h4></div>
                                            <div className="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-blue-500 group-hover:text-white transition-all"><Icon name="play" size={18} className="text-slate-400 group-hover:text-white ml-1" fill="currentColor" /></div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'practice' && (
                            <div className="animate-view max-w-2xl mx-auto">
                                <div className="flex justify-between items-center mb-6 px-2"><button onClick={() => setView('home')} className="text-slate-400 hover:text-slate-700 font-bold text-sm flex items-center gap-1"><Icon name="x" size={16} /> Quit</button><span className="text-xs font-black px-3 py-1 rounded-full uppercase bg-blue-100 text-blue-700">{qIndex === -1 ? 'THEORY' : `Question ${qIndex + 1} / ${exercises.length}`}</span></div>
                                {qIndex === -1 ? (
                                    <div className="glass-card p-10 rounded-[3rem] animate-pop text-center">
                                        <h3 className="text-2xl font-black mb-6">{currentTopic}</h3>
                                        <div className="bg-slate-50 p-6 rounded-2xl text-left font-medium text-slate-700 mb-8">Ready to start?</div>
                                        <button onClick={() => setQIndex(0)} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold text-lg">Start</button>
                                    </div>
                                ) : (
                                    <PracticeView
                                        key={exercises[qIndex] ? exercises[qIndex].id : 'loading'}
                                        exercise={exercises[qIndex]}
                                        onAnswer={(isCorrect, answerData) => {
                                            if (!isCorrect) { setCurrentMistakes(prev => [...prev, { ...exercises[qIndex], userAnswer: answerData }]); } else { setScore(s => s + 1); }
                                            if(qIndex + 1 < exercises.length) { setQIndex(i => i + 1); }
                                            else {
                                                const finalMistakes = !isCorrect ? [...currentMistakes, { ...exercises[qIndex], userAnswer: answerData }] : currentMistakes;
                                                if (isFastParty) {
                                                    // SAVE RESULT FOR TEACHER VIEW
                                                    const resultData = {
                                                        name: studentName,
                                                        score: score + (isCorrect ? 1 : 0),
                                                        total: exercises.length,
                                                        code: teacherCode,
                                                        date: new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                                                        mistakes: finalMistakes // Added mistakes here
                                                    };
                                                    const currentResults = JSON.parse(localStorage.getItem('class_results') || '[]');
                                                    localStorage.setItem('class_results', JSON.stringify([resultData, ...currentResults]));

                                                    // Fast Party Completion Logic
                                                    alert(`Great job ${studentName}! 🎉\n\nYour score of ${score + (isCorrect ? 1 : 0)}/${exercises.length} has been successfully sent to Teacher Code: ${teacherCode}.`);
                                                    setView('landing');
                                                    setIsFastParty(false);
                                                } else {
                                                    // Regular Practice Completion
                                                    saveResult(currentTopic, score + (isCorrect ? 1 : 0), exercises.length, finalMistakes);
                                                    setTimeout(() => { setShowConfetti(true); setTimeout(() => setShowConfetti(false), 3000); setView('stats'); }, 500);
                                                }
                                            }
                                        }}
                                    />
                                )}
                            </div>
                        )}

                        {view === 'theory-view' && (
                            <div className="animate-view max-w-2xl mx-auto">
                                <button onClick={() => setView('home')} className="text-slate-400 hover:text-slate-700 font-bold text-sm flex items-center gap-1 mb-6 text-left"><Icon name="arrow-left" size={16} /> Back</button>
                                <TheoryCard topic={currentTopic} onStart={() => {
                                    setAppMode('practice');
                                    handleTopicSelect(currentTopic);
                                }}/>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
